---
import Layout from '../layouts/Layout.astro';
import DashboardContent from '../components/DashboardContent.jsx';
import Balatro from '../components/Balatro.jsx';
import { createClient } from '@supabase/supabase-js';

// Server-side auth check and data fetching
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const user = Astro.locals.user;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

// Create authenticated client
const supabase = createClient(supabaseUrl, supabaseKey, {
  global: {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  },
});

let profile: any = null;
let activities: any[] = [];
let totalPosts: number = 0;
let totalUsers: number = 0;

if (user) {
  // Fetch admin profile
  const { data: profileData } = await supabase
    .from('admin_profiles')
    .select('*')
    .eq('id', user.id)
    .single();
  profile = profileData;

  // Fetch recent activity logs
  const { data: activityData } = await supabase
    .from('activity_logs')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(5);
  activities = activityData || [];

  // Fetch total posts count
  const { count: postsCount } = await supabase
    .from('posts')
    .select('*', { count: 'exact', head: true });
  totalPosts = postsCount || 0;

  // Fetch total admin users count
  const { count: usersCount } = await supabase
    .from('admin_profiles')
    .select('*', { count: 'exact', head: true });
  totalUsers = usersCount || 0;
}
---

<Layout title="Admin Dashboard - Project Overlord" shouldPadHeader={true}>
  <div class="relative min-h-screen overflow-hidden">
    <!-- Background Effect -->
    <div class="fixed inset-0 w-full h-full bg-zinc-950 -z-10">
      <Balatro
        isRotate={true}
        mouseInteraction={true}
        pixelFilter={700}
        spinSpeed={1.5}
        client:load
      />
    </div>

    <!-- Overlay -->
    <div class="fixed inset-0 bg-gradient-to-b from-zinc-950/60 via-zinc-950/80 to-zinc-950 -z-10">
    </div>

    <!-- Dashboard Content -->
    <div class="relative z-10">
      <DashboardContent
        client:load
        user={user}
        profile={profile}
        activities={activities as any}
        totalPosts={totalPosts}
        totalUsers={totalUsers}
      />
    </div>
  </div>
</Layout>
